generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model assessment_histories {
  id            Int         @id @default(autoincrement())
  assessment_id Int
  field_name    String
  old_value     String?
  new_value     String?
  changed_by    Int?
  created_at    DateTime    @default(now())
  assessments   assessments @relation(fields: [assessment_id], references: [id])

  @@index([assessment_id])
}

model assessment_locks {
  id            Int         @id @default(autoincrement())
  assessment_id Int         @unique
  locked_by     Int?
  locked_at     DateTime    @default(now())
  reason        String?
  assessments   assessments @relation(fields: [assessment_id], references: [id])

  @@index([assessment_id])
}

model assessments {
  id                                      Int                    @id @default(autoincrement())
  student_id                              Int
  pilot_school_id                         Int?
  assessment_type                         String
  subject                                 String
  level                                   String?
  notes                                   String?
  assessed_date                           DateTime?
  added_by_id                             Int?
  is_temporary                            Boolean                @default(false)
  assessed_by_mentor                      Boolean                @default(false)
  mentor_assessment_id                    String?
  created_at                              DateTime               @default(now())
  updated_at                              DateTime
  created_by_role                         String?
  record_status                           RecordStatus           @default(production)
  test_session_id                         String?
  assessment_sample                       String?
  student_consent                         String?
  verified_by_id                          Int?
  verified_at                             DateTime?
  verification_notes                      String?
  is_locked                               Boolean                @default(false)
  locked_by_id                            Int?
  locked_at                               DateTime?
  assessment_histories                    assessment_histories[]
  assessment_locks                        assessment_locks?
  users_assessments_added_by_idTousers    users?                 @relation("assessments_added_by_idTousers", fields: [added_by_id], references: [id])
  users_assessments_locked_by_idTousers   users?                 @relation("assessments_locked_by_idTousers", fields: [locked_by_id], references: [id])
  pilot_schools                           pilot_schools?         @relation(fields: [pilot_school_id], references: [id])
  students                                students               @relation(fields: [student_id], references: [id])
  users_assessments_verified_by_idTousers users?                 @relation("assessments_verified_by_idTousers", fields: [verified_by_id], references: [id])

  @@index([assessed_by_mentor])
  @@index([assessed_date])
  @@index([assessment_type])
  @@index([is_locked])
  @@index([is_temporary])
  @@index([pilot_school_id])
  @@index([record_status])
  @@index([student_id])
  @@index([subject])
  @@index([test_session_id])
  @@index([verified_by_id])
}

model attendance_records {
  id         Int      @id @default(autoincrement())
  student_id Int
  teacher_id Int
  date       DateTime
  status     String
  notes      String?
  created_at DateTime @default(now())
  updated_at DateTime
  users      users    @relation(fields: [teacher_id], references: [id])

  @@index([date])
  @@index([student_id])
  @@index([teacher_id])
}

model audit_logs {
  id             Int      @id @default(autoincrement())
  user_id        Int?
  user_role      String?
  user_email     String?
  action         String
  resource_type  String
  resource_id    Int?
  resource_name  String?
  old_values     Json?
  new_values     Json?
  changed_fields Json?
  ip_address     String?
  user_agent     String?
  session_id     String?
  status         String
  error_message  String?
  metadata       Json?
  created_at     DateTime @default(now())

  @@index([action])
  @@index([created_at])
  @@index([resource_id])
  @@index([resource_type])
  @@index([status])
  @@index([user_id])
  @@index([user_role])
}

model bulk_imports {
  id              Int      @id @default(autoincrement())
  import_type     String
  file_name       String?
  file_path       String?
  total_rows      Int?
  successful_rows Int?
  failed_rows     Int?
  errors          Json?
  imported_by     Int?
  status          String   @default("pending")
  created_at      DateTime @default(now())
  updated_at      DateTime

  @@index([import_type])
  @@index([status])
}

model clusters {
  id          Int      @id @default(autoincrement())
  name        String
  code        String   @unique
  description String?
  created_at  DateTime @default(now())
  updated_at  DateTime
}

model dashboard_stats {
  id                   Int      @id @default(autoincrement())
  cache_key            String   @unique
  role                 String
  user_id              Int?
  total_schools        Int      @default(0)
  total_students       Int      @default(0)
  total_teachers       Int      @default(0)
  total_mentors        Int      @default(0)
  total_assessments    Int      @default(0)
  baseline_assessments Int      @default(0)
  midline_assessments  Int      @default(0)
  endline_assessments  Int      @default(0)
  language_assessments Int      @default(0)
  math_assessments     Int      @default(0)
  stats_data           Json?
  last_updated         DateTime
  created_at           DateTime @default(now())

  @@index([cache_key])
  @@index([last_updated])
  @@index([role])
  @@index([user_id])
}

model intervention_programs {
  id                    Int                     @id @default(autoincrement())
  name                  String
  description           String?
  start_date            DateTime
  end_date              DateTime?
  target_group          String?
  expected_outcomes     String?
  is_active             Boolean                 @default(true)
  created_at            DateTime                @default(now())
  updated_at            DateTime
  student_interventions student_interventions[]
}

model ip_whitelist {
  id            Int      @id @default(autoincrement())
  ip_address    String   @unique
  description   String?
  allowed_roles Json?
  is_active     Boolean  @default(true)
  added_by      Int?
  created_at    DateTime @default(now())
  updated_at    DateTime

  @@index([ip_address])
  @@index([is_active])
}

model mentor_school_assignments {
  id                                                    Int           @id @default(autoincrement())
  mentor_id                                             Int
  pilot_school_id                                       Int
  subject                                               String
  assigned_by_id                                        Int?
  assigned_date                                         DateTime      @default(now())
  is_active                                             Boolean       @default(true)
  notes                                                 String?
  created_at                                            DateTime      @default(now())
  updated_at                                            DateTime
  users_mentor_school_assignments_assigned_by_idTousers users?        @relation("mentor_school_assignments_assigned_by_idTousers", fields: [assigned_by_id], references: [id])
  users_mentor_school_assignments_mentor_idTousers      users         @relation("mentor_school_assignments_mentor_idTousers", fields: [mentor_id], references: [id])
  pilot_schools                                         pilot_schools @relation(fields: [pilot_school_id], references: [id])

  @@unique([mentor_id, pilot_school_id, subject])
  @@index([is_active])
  @@index([mentor_id])
  @@index([pilot_school_id])
  @@index([subject])
}

model teacher_school_assignments {
  id                                                     Int           @id @default(autoincrement())
  teacher_id                                             Int
  pilot_school_id                                        Int
  subject                                                String
  assigned_by_id                                         Int?
  assigned_date                                          DateTime      @default(now())
  is_active                                              Boolean       @default(true)
  notes                                                  String?
  created_at                                             DateTime      @default(now())
  updated_at                                             DateTime
  users_teacher_school_assignments_assigned_by_idTousers users?        @relation("teacher_school_assignments_assigned_by_idTousers", fields: [assigned_by_id], references: [id])
  teacher                                                users         @relation("teacher_school_assignments_teacher_idTousers", fields: [teacher_id], references: [id])
  pilot_schools                                          pilot_schools @relation(fields: [pilot_school_id], references: [id])

  @@unique([teacher_id, pilot_school_id, subject])
  @@index([is_active])
  @@index([teacher_id])
  @@index([pilot_school_id])
  @@index([subject])
}

model mentoring_visits {
  id                                     Int            @id @default(autoincrement())
  mentor_id                              Int
  pilot_school_id                        Int?
  visit_date                             DateTime
  level                                  String?
  purpose                                String?
  activities                             String?
  observations                           String?
  recommendations                        String?
  follow_up_actions                      String?
  photos                                 Json?
  participants_count                     Int?
  duration_minutes                       Int?
  status                                 String         @default("scheduled")
  created_at                             DateTime       @default(now())
  updated_at                             DateTime
  action_plan                            String?
  activities_data                        Json?
  activity1_clear_instructions           Boolean?
  activity1_demonstrated                 Boolean?
  activity1_duration                     Int?
  activity1_followed_process             Boolean?
  activity1_individual                   String?
  activity1_name_language                String?
  activity1_name_numeracy                String?
  activity1_no_clear_instructions_reason String?
  activity1_not_followed_reason          String?
  activity1_small_groups                 String?
  activity1_students_practice            String?
  activity1_type                         String?
  activity1_unclear_reason               String?
  activity2_clear_instructions           Boolean?
  activity2_demonstrated                 Boolean?
  activity2_duration                     Int?
  activity2_followed_process             Boolean?
  activity2_individual                   String?
  activity2_name_language                String?
  activity2_name_numeracy                String?
  activity2_no_clear_instructions_reason String?
  activity2_not_followed_reason          String?
  activity2_small_groups                 String?
  activity2_students_practice            String?
  activity2_type                         String?
  activity2_unclear_reason               String?
  activity3_clear_instructions           Boolean?
  activity3_demonstrated                 Boolean?
  activity3_duration                     Int?
  activity3_individual                   String?
  activity3_name_language                String?
  activity3_name_numeracy                String?
  activity3_no_clear_instructions_reason String?
  activity3_small_groups                 String?
  activity3_students_practice            String?
  children_grouped_appropriately         Boolean?
  class_in_session                       Boolean        @default(true)
  class_not_in_session_reason            String?
  class_started_on_time                  Boolean?
  classes_conducted_before               Int?
  classes_conducted_before_visit         Int?
  commune                                String?
  district                               String?
  feedback_for_teacher                   String?
  follow_up_required                     Boolean        @default(false)
  followed_lesson_plan                   Boolean?
  followed_session_plan                  Boolean?
  full_session_observed                  Boolean?
  grade_group                            String?
  grades_observed                        String?
  has_session_plan                       Boolean?
  is_locked                              Boolean        @default(false)
  language_levels_observed               String?
  late_start_reason                      String?
  lesson_plan_feedback                   String?
  locked_at                              DateTime?
  locked_by                              Int?
  materials_present                      String?
  no_follow_plan_reason                  String?
  no_lesson_plan_reason                  String?
  no_session_plan_reason                 String?
  not_followed_reason                    String?
  num_activities_observed                Int?
  number_of_activities                   Int?
  numeracy_levels_observed               String?
  observation                            String?
  photo                                  String?
  plan_appropriate_for_levels            Boolean?
  program_type                           String?        @default("TaRL")
  province                               String?
  questionnaire_data                     Json?
  region                                 String?
  school_id                              Int?
  score                                  Int?
  session_plan_appropriate               Boolean?
  students_active_participation          Boolean?
  students_fully_involved                Boolean?
  students_grouped_by_level              Boolean?
  students_improved                      Int?
  students_improved_from_last_week       Int?
  students_present                       Int?
  subject_observed                       String?
  teacher_feedback                       String?
  teacher_has_lesson_plan                Boolean?
  teacher_id                             Int?
  teaching_materials                     String?
  total_students_enrolled                Int?
  village                                String?
  created_by_role                        String?
  is_temporary                           Boolean        @default(false)
  record_status                          RecordStatus   @default(production)
  test_session_id                        String?
  users                                  users          @relation(fields: [mentor_id], references: [id])
  pilot_schools                          pilot_schools? @relation(fields: [pilot_school_id], references: [id])

  @@index([class_in_session])
  @@index([is_locked])
  @@index([mentor_id])
  @@index([pilot_school_id])
  @@index([record_status])
  @@index([school_id])
  @@index([status])
  @@index([subject_observed])
  @@index([teacher_id])
  @@index([test_session_id])
  @@index([visit_date])
}

model pilot_schools {
  id                        Int                         @id @default(autoincrement())
  province                  String
  district                  String
  cluster_id                Int?
  cluster                   String
  school_name               String
  school_code               String                      @unique
  baseline_start_date       DateTime?
  baseline_end_date         DateTime?
  midline_start_date        DateTime?
  midline_end_date          DateTime?
  endline_start_date        DateTime?
  endline_end_date          DateTime?
  created_at                DateTime                    @default(now())
  updated_at                DateTime
  is_locked                 Boolean                     @default(false)
  assessments                assessments[]
  mentor_school_assignments  mentor_school_assignments[]
  mentoring_visits           mentoring_visits[]
  students                   students[]
  teacher_school_assignments teacher_school_assignments[]
  users                      users[]

  @@index([baseline_start_date])
  @@index([cluster])
  @@index([district])
  @@index([is_locked])
  @@index([midline_start_date])
  @@index([province])
  @@index([school_code])
}

model progress_trackings {
  id               Int      @id @default(autoincrement())
  student_id       Int
  tracking_date    DateTime
  khmer_progress   String?
  math_progress    String?
  attendance_rate  Float?
  behavior_notes   String?
  teacher_comments String?
  created_at       DateTime @default(now())
  updated_at       DateTime

  @@index([student_id])
  @@index([tracking_date])
}

model provinces {
  id           Int       @id @default(autoincrement())
  name_english String
  name_khmer   String?
  code         String    @unique
  created_at   DateTime  @default(now())
  updated_at   DateTime
  schools      schools[]
}

model quick_login_users {
  id                      Int       @id @default(autoincrement())
  username                String    @unique
  password                String
  role                    String    @default("teacher")
  province                String?
  subject                 String?
  is_active               Boolean   @default(true)
  created_at              DateTime  @default(now())
  updated_at              DateTime
  district                String?
  holding_classes         String?
  pilot_school_id         Int?
  onboarding_completed    Json?
  onboarding_completed_at DateTime?
  show_onboarding         Boolean   @default(true)

  @@index([username])
}

model rate_limits {
  id             Int       @id @default(autoincrement())
  identifier     String
  endpoint       String
  requests_count Int       @default(1)
  window_start   DateTime  @default(now())
  blocked_until  DateTime?
  created_at     DateTime  @default(now())
  updated_at     DateTime

  @@unique([identifier, endpoint, window_start])
  @@index([blocked_until])
  @@index([endpoint])
  @@index([identifier])
  @@index([window_start])
}

model report_exports {
  id           Int       @id @default(autoincrement())
  report_type  String
  filters      Json?
  file_path    String?
  status       String    @default("processing")
  exported_by  Int?
  created_at   DateTime  @default(now())
  completed_at DateTime?

  @@index([report_type])
  @@index([status])
}

model resource_views {
  id          Int      @id @default(autoincrement())
  resource_id Int
  user_id     Int?
  ip_address  String?
  user_agent  String?
  viewed_at   DateTime @default(now())

  @@index([resource_id])
  @@index([user_id])
}

model resources {
  id           Int      @id @default(autoincrement())
  title        String
  description  String?
  type         String?
  file_url     String?
  youtube_url  String?
  grade_levels String?
  subjects     String?
  uploaded_by  Int?
  is_public    Boolean  @default(false)
  views_count  Int      @default(0)
  created_at   DateTime @default(now())
  updated_at   DateTime

  @@index([is_public])
  @@index([type])
}

model school_classes {
  id            Int        @id @default(autoincrement())
  school_id     Int
  name          String
  grade         Int
  teacher_name  String?
  student_count Int?
  created_at    DateTime   @default(now())
  updated_at    DateTime
  schools       schools    @relation(fields: [school_id], references: [id])
  students      students[]

  @@index([school_id])
}

model schools {
  id             Int              @id @default(autoincrement())
  name           String
  code           String           @unique
  province_id    Int
  district       String?
  commune        String?
  village        String?
  school_type    String?
  level          String?
  total_students Int?
  total_teachers Int?
  latitude       Float?
  longitude      Float?
  phone          String?
  email          String?
  is_active      Boolean          @default(true)
  created_at     DateTime         @default(now())
  updated_at     DateTime
  school_classes school_classes[]
  provinces      provinces        @relation(fields: [province_id], references: [id])

  @@index([code])
  @@index([province_id])
}

model settings {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String?
  type        String?
  description String?
  updated_by  Int?
  created_at  DateTime @default(now())
  updated_at  DateTime

  @@index([key])
}

model student_assessment_eligibilities {
  id              Int       @id @default(autoincrement())
  student_id      Int
  assessment_type String
  is_eligible     Boolean   @default(true)
  reason          String?
  eligible_from   DateTime?
  eligible_until  DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime
  students        students  @relation(fields: [student_id], references: [id])

  @@unique([student_id, assessment_type])
  @@index([student_id])
}

model student_interventions {
  id                      Int                   @id @default(autoincrement())
  student_id              Int
  intervention_program_id Int
  start_date              DateTime
  end_date                DateTime?
  status                  String                @default("active")
  progress_notes          String?
  outcome                 String?
  created_at              DateTime              @default(now())
  updated_at              DateTime
  intervention_programs   intervention_programs @relation(fields: [intervention_program_id], references: [id])
  students                students              @relation(fields: [student_id], references: [id])

  @@index([intervention_program_id])
  @@index([student_id])
}

model students {
  id                               Int                                @id @default(autoincrement())
  school_class_id                  Int?
  pilot_school_id                  Int?
  name                             String
  age                              Int?
  gender                           String?
  guardian_name                    String?
  guardian_phone                   String?
  address                          String?
  photo                            String?
  baseline_assessment              String?
  midline_assessment               String?
  endline_assessment               String?
  baseline_khmer_level             String?
  baseline_math_level              String?
  midline_khmer_level              String?
  midline_math_level               String?
  endline_khmer_level              String?
  endline_math_level               String?
  is_active                        Boolean                            @default(true)
  is_temporary                     Boolean                            @default(false)
  added_by_id                      Int?
  added_by_mentor                  Boolean                            @default(false)
  assessed_by_mentor               Boolean                            @default(false)
  mentor_created_at                DateTime?
  created_at                       DateTime                           @default(now())
  updated_at                       DateTime
  created_by_role                  String?
  record_status                    RecordStatus                       @default(production)
  test_session_id                  String?
  student_id                       String?                            @unique
  grade                            Int?
  assessments                      assessments[]
  student_assessment_eligibilities student_assessment_eligibilities[]
  student_interventions            student_interventions[]
  users                            users?                             @relation(fields: [added_by_id], references: [id])
  pilot_schools                    pilot_schools?                     @relation(fields: [pilot_school_id], references: [id])
  school_classes                   school_classes?                    @relation(fields: [school_class_id], references: [id])

  @@index([added_by_id])
  @@index([added_by_mentor])
  @@index([is_temporary])
  @@index([pilot_school_id])
  @@index([record_status])
  @@index([school_class_id])
  @@index([test_session_id])
}

model teaching_activities {
  id             Int      @id @default(autoincrement())
  teacher_id     Int
  activity_date  DateTime
  subject        String
  topic          String
  duration       Int?
  materials_used String?
  student_count  Int?
  notes          String?
  created_at     DateTime @default(now())
  updated_at     DateTime
  users          users    @relation(fields: [teacher_id], references: [id])

  @@index([activity_date])
  @@index([teacher_id])
}

model test_sessions {
  id                    String    @id
  user_id               Int
  user_role             String
  started_at            DateTime  @default(now())
  expires_at            DateTime?
  status                String    @default("active")
  student_count         Int       @default(0)
  assessment_count      Int       @default(0)
  mentoring_visit_count Int       @default(0)
  notes                 String?
  created_at            DateTime  @default(now())
  updated_at            DateTime

  @@index([expires_at])
  @@index([status])
  @@index([user_id])
  @@index([user_role])
}

model user_schools {
  id              Int      @id @default(autoincrement())
  user_id         Int
  school_id       Int?
  pilot_school_id Int?
  assigned_date   DateTime @default(now())
  assigned_by     Int?
  is_primary      Boolean  @default(false)

  @@unique([user_id, pilot_school_id])
  @@unique([user_id, school_id])
  @@index([school_id])
  @@index([user_id])
}

model user_sessions {
  id                 String    @id
  user_id            Int
  user_role          String
  ip_address         String?
  user_agent         String?
  device_info        Json?
  started_at         DateTime  @default(now())
  last_activity      DateTime  @default(now())
  expires_at         DateTime
  is_active          Boolean   @default(true)
  terminated_at      DateTime?
  termination_reason String?
  created_at         DateTime  @default(now())

  @@index([expires_at])
  @@index([is_active])
  @@index([last_activity])
  @@index([user_id])
}

model users {
  id                                                                        Int                         @id @default(autoincrement())
  name                                                                      String
  email                                                                     String                      @unique
  username                                                                  String?                     @unique
  profile_photo                                                             String?
  sex                                                                       String?
  phone                                                                     String?
  holding_classes                                                           String?
  assigned_subject                                                          String?
  role                                                                      String                      @default("teacher")
  email_verified_at                                                         DateTime?
  password                                                                  String
  remember_token                                                            String?
  onboarding_completed                                                      Json?
  onboarding_completed_at                                                   DateTime?
  show_onboarding                                                           Boolean                     @default(true)
  created_at                                                                DateTime                    @default(now())
  updated_at                                                                DateTime
  profile_expires_at                                                        DateTime?
  original_school_id                                                        Int?
  original_subject                                                          String?
  original_classes                                                          String?
  school_id                                                                 Int?
  subject                                                                   String?
  pilot_school_id                                                           Int?
  province                                                                  String?
  district                                                                  String?
  commune                                                                   String?
  village                                                                   String?
  is_active                                                                 Boolean                     @default(true)
  test_mode_enabled                                                         Boolean                     @default(false)
  login_type                                                                String?                     @default("email") @db.VarChar(20)
  username_login                                                            String?                     @unique @db.VarChar(255)
  migrated_from_quick_login                                                 Boolean?                    @default(false)
  migration_date                                                            DateTime?                   @db.Timestamp(6)
  onboarding_activities                                                     Json?
  assessments_assessments_added_by_idTousers                                assessments[]               @relation("assessments_added_by_idTousers")
  assessments_assessments_locked_by_idTousers                               assessments[]               @relation("assessments_locked_by_idTousers")
  assessments_assessments_verified_by_idTousers                             assessments[]               @relation("assessments_verified_by_idTousers")
  attendance_records                                                        attendance_records[]
  mentor_school_assignments_mentor_school_assignments_assigned_by_idTousers mentor_school_assignments[] @relation("mentor_school_assignments_assigned_by_idTousers")
  mentor_school_assignments_mentor_school_assignments_mentor_idTousers      mentor_school_assignments[] @relation("mentor_school_assignments_mentor_idTousers")
  mentoring_visits                                                          mentoring_visits[]
  students                                                                  students[]
  teaching_activities                                                       teaching_activities[]
  teacher_school_assignments_teacher_school_assignments_assigned_by_idTousers teacher_school_assignments[] @relation("teacher_school_assignments_assigned_by_idTousers")
  teacher_school_assignments_teacher_school_assignments_teacher_idTousers     teacher_school_assignments[] @relation("teacher_school_assignments_teacher_idTousers")
  pilot_schools                                                             pilot_schools?              @relation(fields: [pilot_school_id], references: [id])

  @@index([email])
  @@index([pilot_school_id])
  @@index([role])
}

enum RecordStatus {
  production
  test_mentor
  test_teacher
  demo
  archived
}
